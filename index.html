<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brasil em Pauta - Online</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="shortcut icon" href="img/favicon.png" type="image/png">
    <link
        href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400&family=Playfair+Display:wght@400;700&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Módulos JS-->
    <script src="scripts/moverMapa.js"></script>
    <script src="scripts/tailwind.js"></script>
    <script src="scripts/acoesJogo.js"></script>


    <style>
        /* Custom styles to match original feeling */
        .boss-battle #bg-layer {
            filter: sepia(100%) hue-rotate(-50deg) saturate(200%);
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>


<body class="font-body antialiased min-h-screen flex flex-col bg-background text-foreground">

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2"></div>

    <!-- APP CONTAINER -->
    <div id="app" class="flex flex-col flex-1">
        <!-- Views injected by JS -->
    </div>

    <!-- DIALOG (END GAME) -->
    <div id="end-game-dialog" class="fixed inset-0 z-50 bg-black/80 hidden items-center justify-center p-4">
        <div
            class="bg-card border border-border rounded-lg shadow-lg w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-6 pb-2">
                <h2 class="text-2xl font-headline font-semibold text-primary">Fim de Jogo!</h2>
                <p id="end-game-message" class="text-muted-foreground mt-2 mb-4"></p>

                <div class="w-full h-48 bg-white/5 rounded p-2">
                    <canvas id="educationChart"></canvas>
                </div>
            </div>

            <div class="p-6 pt-0 flex justify-end gap-2 mt-4">
                <button id="btn-restart" onclick="Game.restart()"
                    class="hidden inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                    Reiniciar
                </button>
                <button onclick="location.reload()"
                    class="inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium border border-input bg-secondary hover:bg-secondary/80 h-10 px-4 py-2">
                    Sair
                </button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // --- CONSTANTS & CONFIG ---
        // const API_URL = "https://brasil-em-pauta.onrender.com";
        const API_URL = "https://brasil-em-pauta.onrender.com";
        // --- MAP CONTROLS (ZOOM & PAN) ---
        // --- MAP CONTROLS (ZOOM & PAN) ---


        // Mantendo as coordenadas visuais dos tiles (Client-Side)
        const TILES = [
            { id: 1, label: "1", top: 22, left: 23 }, { id: 2, label: "2", top: 32, left: 13 },
            { id: 3, label: "3", top: 39, left: 29 }, { id: 4, label: "4", top: 15, left: 37 },
            { id: 5, label: "5", top: 53, left: 48 }, { id: 6, label: "6", top: 45, left: 39 },
            { id: 7, label: "7", top: 40, left: 47 }, { id: 8, label: "8", top: 43, left: 54 },
            { id: 9, label: "9", top: 23, left: 49 }, { id: 10, label: "10", top: 82, left: 53 },
            { id: 11, label: "11", top: 75, left: 61 }, { id: 12, label: "12", top: 69, left: 66 },
            { id: 13, label: "13", top: 63, left: 48 }, { id: 14, label: "14", top: 56, left: 60 },
            { id: 15, label: "15", top: 86, left: 57 }, { id: 16, label: "16", top: 63, left: 48 },
            { id: 17, label: "17", top: 69, left: 66 }, { id: 18, label: "18", top: 39, left: 64 },
            { id: 19, label: "19", top: 44, left: 70 }, { id: 20, label: "20", top: 49, left: 79 },
            { id: 21, label: "21", top: 25, left: 76 }, { id: 22, label: "22", top: 32, left: 76 },
            { id: 23, label: "23", top: 20, left: 63 }, { id: 24, label: "24", top: 59, left: 77 },
            { id: 25, label: "25", top: 68, left: 75 },
        ];

        const INDICATORS_INFO = {
            economy: { name: "Economia", icon: "dollar-sign" },
            education: { name: "Educação", icon: "book-open" },
            wellbeing: { name: "Bem-Estar", icon: "heart" },
            popular_support: { name: "Apoio Popular", icon: "users" },
            hunger: { name: "Fome", icon: "utensils" },
            military_religion: { name: "Militar/Religião", icon: "shield" }
        };

        // Mantendo apenas visualização de chefes, lógica está no servidor
        const BOSS_VISUALS = {
            10: { name: "Crise Midiática", icon: "tv" },
            20: { name: "Levante Militar", icon: "swords" },
            25: { name: "Julgamento Final", icon: "scale" }
        };

        // --- STATE MANAGEMENT ---
        let State_geral = {};

        const State = {
            userUid: null,
            playerName: '',
            gameCode: null,
            isCreator: false,
            pollingInterval: null,
            dificuty: null,

            // Server Data
            serverData: {
                status: 'waiting', // waiting, in_progress, finished
                players: [],
                currentCard: null,
                logs: [],
                stats: {}, // economy, etc
                board_position: 0,
                current_player_index: 0
            },

            ui: {
                tab: 'decisao',
                isProcessing: false,
                view: 'lobby' // lobby, waiting, game
            }
        };

        // --- UTILS ---
        function getOrSetUid() {
            let uid = localStorage.getItem('bp_user_uid');
            if (!uid) {
                uid = 'user_' + Math.random().toString(36).substring(2, 9) + Date.now().toString(36);
                localStorage.setItem('bp_user_uid', uid);
            }
            return uid;
        }

        function showToast(title, description, variant = 'default') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgClass = variant === 'destructive' ? 'bg-destructive text-destructive-foreground' : 'bg-card text-foreground';
            toast.className = `flex w-full max-w-sm items-center justify-between space-x-4 overflow-hidden rounded-md border p-4 shadow-lg transition-all animate-in slide-in-from-right-full ${bgClass}`;
            toast.innerHTML = `<div><div class="font-bold">${title}</div><div class="text-sm opacity-90">${description}</div></div>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // --- API SERVICE ---
        const API = {
            request: async (endpoint, method = 'GET', body = null) => {
                try {
                    const options = {
                        method,
                        headers: { 'Content-Type': 'application/json' }
                    };
                    if (body) options.body = JSON.stringify(body);

                    const res = await fetch(`${API_URL}${endpoint}`, options);
                    const data = await res.json();

                    if (!res.ok) throw new Error(data.message || 'Erro na requisição');
                    return data;
                } catch (error) {
                    console.error("API Error:", error);
                    showToast("Erro", error.message, "destructive");
                    throw error;
                }
            }
        };

        // --- GAME ACTIONS ---


        // --- RENDERER ---
        const Renderer = {
            renderLobby: () => {
                State.ui.view = 'lobby';
                const app = document.getElementById('app');
                app.innerHTML = `
                <div class="relative flex min-h-screen flex-col items-center justify-center overflow-hidden bg-black">
                    
                    <div class="absolute inset-0 z-0 bg-[url('./img/fundo_de_tela.jpg')] bg-cover bg-center bg-black/40 bg-blend-overlay blur-sm scale-110"></div>

                    <div class="relative z-10 flex flex-col items-center w-full max-w-4xl p-4">
                        
                        <div class="flex items-center space-x-3 mb-8">
                            <i data-lucide="scale" class="h-12 w-12"></i>
                            <h1 class="text-5xl font-bold tracking-tight text-white font-headline drop-shadow-md">Brasil em Pauta</h1>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-6 w-full">
                            <div class="bg-card/90 backdrop-blur border border-primary/20 rounded-xl shadow-2xl p-6 flex flex-col gap-4">
                                <h2 class="text-2xl font-headline text-center">Nova Partida</h2>
                                <input type="text" id="create-name" placeholder="Seu Nome" value="${State.playerName}" class="flex h-10 w-full rounded-md border border-input bg-background/50 px-3 py-2 text-sm focus:ring-2 focus:ring-primary outline-none">
                                <div class="space-y-2">
                                    <h1 class="text-xl text-center block">Dificuldade</h1>
                                    <select id="difficulty-select" class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                                        <option value="easy">Fácil</option>
                                        <option value="medium">Médio</option>
                                        <option value="hard">Difícil</option>
                                    </select>
                                </div>
                                <div>
                                    <input type="checkbox" name="observer" id="observer">
                                    <label for="observer">Quero ser somente um observador</label>
                                </div>
                                <button onclick="Game.create()" id="btn-create" class="bg-primary text-primary-foreground hover:bg-secondary/90 h-10 px-4 py-2 rounded-md font-medium transition-all">
                                    Criar Sala
                                </button>
                            </div>

                            <div class="bg-card/90 backdrop-blur border border-white/10 rounded-xl shadow-2xl p-6 flex flex-col gap-4">
                                <h2 class="text-2xl font-headline text-white text-center">Entrar em Sala</h2>
                                <input type="text" id="join-name" placeholder="Seu Nome" value="${State.playerName}" class="flex h-10 w-full rounded-md border border-input bg-background/50 px-3 py-2 text-sm focus:ring-2 focus:ring-group outline-none">
                                <input type="text" id="join-code" placeholder="CÓDIGO (Ex: X7B9K2)" class="flex h-10 w-full rounded-md border border-input bg-background/50 px-3 py-2 text-sm uppercase focus:ring-2 focus:ring-group outline-none tracking-widest font-bold text-center">
                                <button onclick="Game.join()" id="btn-join" class="bg-group text-secondary-foreground hover:bg-secondary/80 h-10 px-4 py-2 rounded-md font-medium transition-all">
                                    Conectar
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            `;
                lucide.createIcons();
            },

            renderWaitingRoom: () => {
                State.ui.view = 'waiting';
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="flex min-h-screen flex-col items-center justify-center bg-background p-4">
                        <div class="w-full max-w-md bg-card border border-border rounded-lg shadow-xl p-6 text-center">
                            <h2 class="text-xl font-headline mb-2 text-muted-foreground">Sala de Espera</h2>
                            <div class="text-4xl font-bold tracking-[0.5em] text-primary mb-6 bg-secondary/30 p-4 rounded border border-dashed border-primary/30">
                                ${State.gameCode}
                            </div>
                            
                            <div class="mb-6">
                                <h3 class="text-sm font-medium text-left mb-2 ml-1">Jogadores Conectados:</h3>
                                <div id="player-list" class="space-y-2">
                                    <!-- Player list injected here -->
                                </div>
                            </div>

                            <div id="creator-controls" class="hidden">
                                <button onclick="Game.startGame()" class="w-full bg-primary text-primary-foreground h-12 rounded-md font-bold text-lg hover:bg-primary/90 transition-all shadow-lg shadow-primary/20">
                                    INICIAR PARTIDA
                                </button>
                            </div>
                            <div id="waiting-msg" class="hidden text-sm text-muted-foreground animate-pulse">
                                Aguardando o líder iniciar...
                            </div>
                        </div>
                    </div>
                `;
                Renderer.updateWaitingUI();
            },

            updateWaitingUI: () => {
                const list = document.getElementById('player-list');
                if (!list) return;

                list.innerHTML = State.serverData.players.map(p => `
                    <div class="flex items-center justify-between p-3 bg-secondary rounded-md border border-transparent ${p.user_uid === State.userUid ? 'border-primary/50' : ''}">
                        <div class="flex items-center gap-3">
                            <div class="h-8 w-8 rounded-full bg-primary/20 flex items-center justify-center text-primary font-bold">
                                ${p.nickname.charAt(0).toUpperCase()}
                            </div>
                            <span class="font-medium">${p.nickname} ${p.user_uid === State.userUid ? '(Você)' : ''}</span>
                        </div>
                        ${p.user_uid === State.serverData.creator_uid ? '<i data-lucide="crown" class="h-4 w-4 text-yellow-500"></i>' : ''}
                    </div>
                `).join('');

                lucide.createIcons();

                const creatorControls = document.getElementById('creator-controls');
                const waitingMsg = document.getElementById('waiting-msg');

                if (State.isCreator) {
                    creatorControls.classList.remove('hidden');
                    waitingMsg.classList.add('hidden');
                } else {
                    creatorControls.classList.add('hidden');
                    waitingMsg.classList.remove('hidden');
                }
            },

            renderGame: () => {
                const app = document.getElementById('app');
                app.className = "flex flex-col min-h-screen bg-background";
                app.innerHTML = `
                    <!-- HEADER -->
                    <header class="bg-card/90 border-b border-border shadow-sm sticky top-0 z-20 backdrop-blur-md">
                        <div class="container mx-auto px-4 h-14 flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i data-lucide="scale" class="h-6 w-6 text-primary"></i>
                                <h1 class="hidden sm:block text-lg font-bold font-headline">Brasil em Pauta</h1>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="flex flex-col items-end">
                                    <span class="text-[10px] text-muted-foreground">CÓDIGO</span>
                                    <span class="text-sm font-bold tracking-widest text-primary leading-none">${State.gameCode}</span>
                                </div>
                                <div class="h-8 w-[1px] bg-border mx-2"></div>
                                <div class="flex items-center gap-2">
                                     <span class="text-xs text-muted-foreground hidden sm:inline">Jogadores:</span>
                                     <div id="header-players" class="flex -space-x-2"></div>
                                </div>
                            </div>
                        </div>
                    </header>

                    <!-- DESKTOP STATS -->
                    <div class="hidden md:block w-full bg-secondary/30 py-3 border-b border-border">
                        <div id="desktop-indicators" class="container mx-auto px-4 grid grid-cols-6 gap-6"></div>
                    </div>

                    <!-- MAIN -->
                    <main class="flex-1 flex flex-col md:grid md:grid-cols-3 md:gap-6 md:p-6 min-h-0 overflow-hidden relative">
                        
                        <!-- MAPA (Esquerda/Centro) -->
                        <div id="view-map" class="col-span-2 relative flex flex-col bg-black rounded-lg overflow-hidden border border-border/50 shadow-2xl touch-none cursor-move">
    
                        <div class="absolute top-4 right-4 z-50 flex flex-col gap-2">
                            <button onclick="MapControls.zoomIn()" class="bg-black/70 text-white p-2 rounded-full border border-white/20 hover:bg-primary transition-colors">
                                <i data-lucide="plus" class="w-6 h-6"></i>
                            </button>
                            <button onclick="MapControls.zoomOut()" class="bg-black/70 text-white p-2 rounded-full border border-white/20 hover:bg-primary transition-colors">
                                <i data-lucide="minus" class="w-6 h-6"></i>
                            </button>
                        </div>

                        <div id="game-board-container" class="relative w-full aspect-[4/3] max-h-[75vh] m-auto origin-center transition-transform duration-75 ease-out">
                            <div id="bg-layer" class="absolute inset-0 w-full h-full bg-cover bg-center transition-all duration-1000"></div>
                            <div id="tiles-layer" class="absolute inset-0 w-full h-full"></div>
                            <div id="boss-overlay-layer"></div>
                        </div>
                    </div>

                        <!-- PAINEL (Direita) -->
                        <div class="col-span-1 flex flex-col h-full min-h-0 overflow-hidden relative bg-card md:rounded-lg md:border md:border-border">
                             <!-- Mobile Content -->
                             <div class="md:hidden flex-1 overflow-y-auto p-4" id="mobile-content-area"></div>
                             
                             <!-- Desktop Content -->
                             <div class="hidden md:flex flex-col h-full" id="desktop-decision-area"></div>
                        </div>
                    </main>

                    <!-- MOBILE NAV -->
                    <nav class="md:hidden bg-card border-t border-border grid grid-cols-4 h-16 pb-safe">
                        <button onclick="Game.setTab('mapa')" class="nav-btn" data-tab="mapa">
                            <i data-lucide="map" class="h-5 w-5 mb-1"></i> Mapa
                        </button>
                        <button onclick="Game.setTab('decisao')" class="nav-btn" data-tab="decisao">
                            <i data-lucide="vote" class="h-5 w-5 mb-1"></i> Decisão
                        </button>
                        <button onclick="Game.setTab('diario')" class="nav-btn" data-tab="diario">
                            <i data-lucide="scroll-text" class="h-5 w-5 mb-1"></i> Diário
                        </button>
                        <button onclick="Game.setTab('nacao')" class="nav-btn" data-tab="nacao">
                            <i data-lucide="activity" class="h-5 w-5 mb-1"></i> Nação
                        </button>
                    </nav>
                `;
                Renderer.updateGameUI();
            },

            updateGameUI: () => {
                if (!State.serverData) return;

                const { stats, board_position, currentCard, players, current_player_index, logs } = State.serverData;
                const currentPlayer = players[current_player_index];
                const isMyTurn = currentPlayer && currentPlayer.user_uid === State.userUid;

                // 1. Header Players
                const headerPlayers = document.getElementById('header-players');
                
                if (headerPlayers) {
                    headerPlayers.innerHTML = players.map((p, idx) => `
                        <div 
                            onclick="showPlayerDetails(${idx})" 
                            class="cursor-pointer relative h-8 w-8 rounded-full border-2 ${idx === current_player_index ? 'border-primary z-10 scale-110' : 'border-background bg-muted'} flex items-center justify-center text-xs font-bold text-foreground bg-secondary transition-transform hover:scale-125" 
                            title="${p.nickname}" 
                        >
                            ${p.nickname.charAt(0).toUpperCase()}
                            
                            ${idx === current_player_index ? '<span class="absolute -top-1 -right-1 h-3 w-3 bg-primary rounded-full animate-ping"></span>' : ''}
                        </div>
                    `).join('');
                }

                // 2. Indicators HTML Builder (COM CEGUEIRA NO HARD MODE)
                const buildIndicators = () => Object.entries(stats).map(([key, value]) => {
                    if (!INDICATORS_INFO[key]) return '';
                    const info = INDICATORS_INFO[key];

                    // Lógica de Cores
                    let color = "bg-yellow-500";
                    if (key === 'hunger') {
                        color = value >= 7 ? "bg-red-600" : (value >= 4 ? "bg-yellow-500" : "bg-emerald-500");
                    } else {
                        color = value <= 3 ? "bg-red-600" : (value <= 6 ? "bg-yellow-500" : "bg-emerald-500");
                    }

                    // --- NOVA LÓGICA: VERIFICAR DIFICULDADE ---
                    const isHard = State.serverData.difficulty === 'hard';

                    // 1. Esconde o número
                    const displayValue = isHard ? "---" : value;

                    // Se for Hard, a barra fica sempre em 100% (cheia), mudando apenas a cor.
                    // Se for Normal, a barra respeita a porcentagem do valor (ex: 3 = 30%).
                    const barWidth = isHard ? "100" : (value * 10);

                    return `
                        <div class="flex flex-col gap-1">
                            <div class="flex justify-between text-xs font-medium text-muted-foreground uppercase tracking-wider">
                                <span class="flex items-center gap-1"><i data-lucide="${info.icon}" class="w-3 h-3"></i> ${info.name}</span>
                                <span class="text-foreground font-bold">${displayValue}</span>
                            </div>
                            <div class="h-1.5 w-full bg-secondary rounded-full overflow-hidden">
                                <div class="h-full ${color} transition-all duration-700" style="width: ${barWidth}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');

                const deskInd = document.getElementById('desktop-indicators');
                if (deskInd) deskInd.innerHTML = buildIndicators();

                // 3. Board Visuals
                const bgLayer = document.getElementById('bg-layer');
                if (bgLayer) {
                    // Lógica visual baseada em status
                    const isChaos = stats.popular_support <= 3 || stats.economy <= 3 || stats.wellbeing <= 3;
                    const isGood = stats.wellbeing >= 7 && stats.education >= 7;

                    // Imagem Padrão (Neutra) - Usada no modo fácil/médio no início
                    let bgSrc = "img/TABULEIRO_0001903.png";

                    if (isChaos) {
                        // Imagem de País Devastado
                        bgSrc = "img/TABULEIRO_0001908.png";
                    } else if (isGood) {
                        // Imagem de País Próspero
                        bgSrc = "img/TABULEIRO_0001918.png";
                    }

                    bgLayer.style.backgroundImage = `url('${bgSrc}')`;
                }

                const tilesLayer = document.getElementById('tiles-layer');
                if (tilesLayer) {
                    tilesLayer.innerHTML = TILES.map(tile => {
                        // API retorna board_position 0-25. Tile ID 1 map to pos 1.
                        const isCurrent = tile.id === board_position;
                        const activeClass = isCurrent ?
                            "scale-150 border-yellow-400 z-20 shadow-[0_0_15px_rgba(250,204,21,0.6)] bg-yellow-600 text-white" :
                            "bg-black/40 border-white/30 text-white/50";

                        return `
                            <div class="absolute w-[3.5%] h-[4.5%] flex justify-center items-center rounded-full text-[10px] font-bold border transition-all duration-500 ${activeClass}" 
                            style="top: ${tile.top}%; left: ${tile.left}%;">
                                ${tile.label}
                            </div>
                        `;
                    }).join('');
                }

                // Boss Overlay Visual
                const bossLayer = document.getElementById('boss-overlay-layer');
                if (bossLayer) {
                    const boss = BOSS_VISUALS[board_position];
                    if (boss) {
                        bossLayer.innerHTML = `
                            <div class="absolute inset-0 bg-black/60 flex items-center justify-center animate-in fade-in duration-1000">
                                <div class="text-center p-6 bg-destructive/20 rounded-xl border border-destructive/50 backdrop-blur-sm">
                                    <i data-lucide="${boss.icon}" class="w-16 h-16 text-destructive mx-auto mb-2 animate-pulse"></i>
                                    <h2 class="text-2xl font-bold text-white uppercase tracking-widest">${boss.name}</h2>
                                    <p class="text-white/80 text-sm mt-1">Momento Decisivo</p>
                                </div>
                            </div>
                        `;
                    } else {
                        bossLayer.innerHTML = '';
                    }
                }


                const showStatus = (opcao) => {
                    if (State_geral.difficulty !== "easy") return '';

                    return Object.entries(opcao.effect).map(([k, v]) => {
                        const val = v > 0 ? `+${v}` : v;
                        const color = (k === 'hunger' ? v < 0 : v > 0) ? 'text-green-500' : 'text-red-500';
                        return `<span class="${color}">${INDICATORS_INFO[k]?.name || k} ${val}</span>`;
                    }).join('')
                }
                // 4. Decision / Card Area
                const buildCard = () => {
                    if (!currentCard) {
                        return `
                            <div class="flex flex-col items-center justify-center h-full text-muted-foreground gap-3 p-8 text-center opacity-50">
                                <i data-lucide="hourglass" class="w-10 h-10 animate-spin-slow"></i>
                                <p>Processando próximo evento...</p>
                            </div>
                        `;
                    }

                    const canAct = isMyTurn && !State.ui.isProcessing;

                    return `
                        <div class="h-full flex flex-col p-4 md:p-6 animate-in slide-in-from-bottom-4 fade-in duration-500">
                            <div class="mb-4">
                                <span class="text-xs font-bold text-primary tracking-widest uppercase border border-primary/30 px-2 py-1 rounded">
                                    Turno de: ${currentPlayer?.nickname}
                                </span>
                                <h2 class="text-xl md:text-2xl font-headline font-bold text-foreground mt-3 leading-tight">
                                    ${currentCard.title}
                                </h2>
                            </div>
                            
                            <div class="flex-1 bg-secondary/20 rounded-lg p-4 mb-4 overflow-y-auto border border-border/50">
                                <p class="text-sm md:text-base leading-relaxed text-foreground/90 font-serif">
                                    ${currentCard.dilemma}
                                </p>
                            </div>

                            <div class="space-y-3">
                                ${currentCard.options.map((opt, idx) => `
                                    <button onclick="Game.makeDecision(${idx})" 
                                        ${!canAct ? 'disabled' : ''}
                                        class="w-full text-left p-4 rounded-lg border transition-all duration-200 group relative overflow-hidden
                                        ${canAct
                            ? 'border-border bg-card hover:border-primary hover:bg-secondary/50 cursor-pointer shadow-sm hover:shadow-md'
                            : 'border-border/50 bg-secondary/30 opacity-60 cursor-not-allowed'
                        }">
                                        <div class="relative z-10">
                                            <span class="font-bold text-sm block mb-1 group-hover:text-primary transition-colors">${opt.text}</span>
                                            <!-- Efeitos escondidos para dificuldade difícil ou mostrados se configurado -->
                                            <div class="flex flex-wrap gap-2 text-[10px] opacity-70">
                                                 ${showStatus(opt)}
                                            </div>
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                            
                            ${!isMyTurn ? `
                                <div class="mt-4 text-center text-xs text-muted-foreground flex items-center justify-center gap-2">
                                    <i data-lucide="lock" class="w-3 h-3"></i> Aguardando decisão de ${currentPlayer?.nickname}...
                                </div>
                            ` : ''}
                        </div>
                    `;
                };

                const buildLogs = () => {
                    if (!logs.length) return `<div class="p-8 text-center text-muted-foreground text-sm">Nenhum registro histórico.</div>`;
                    return `
                        <div class="p-4 space-y-4">
                            <h3 class="font-headline font-bold text-lg mb-2">Diário da União</h3>
                            ${logs.slice().reverse().map(l => `
                                <div class="text-xs p-3 rounded bg-secondary/50 border border-border/50 relative pl-8">
                                    <div class="absolute left-3 top-3 w-2 h-2 rounded-full bg-primary/50"></div>
                                    <p class="font-bold text-primary mb-1">${l.playerName} decidiu:</p>
                                    <p class="mb-1 text-foreground/90">"${l.decision}"</p>
                                    <p class="text-muted-foreground text-[10px] font-mono">${l.effects}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                };

                // Inject Content based on Mobile/Desktop
                const desktopArea = document.getElementById('desktop-decision-area');
                if (desktopArea) desktopArea.innerHTML = buildCard();

                const mobileArea = document.getElementById('mobile-content-area');
                const mapView = document.getElementById('view-map');

                if (window.innerWidth < 768) {
                    if (State.ui.tab === 'mapa') {
                        mapView.classList.remove('hidden');
                        mobileArea.classList.add('hidden');
                    } else {
                        mapView.classList.add('hidden');
                        mobileArea.classList.remove('hidden');

                        if (State.ui.tab === 'decisao') mobileArea.innerHTML = buildCard();
                        else if (State.ui.tab === 'diario') mobileArea.innerHTML = buildLogs();
                        else if (State.ui.tab === 'nacao') mobileArea.innerHTML = `<div class="p-4 space-y-6">${buildIndicators()}</div>`;
                    }
                } else {
                    mapView.classList.remove('hidden');
                }

                // Nav Styling
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    const active = btn.dataset.tab === State.ui.tab;
                    btn.className = `nav-btn flex flex-col items-center justify-center text-xs transition-colors ${active ? 'text-primary font-bold' : 'text-muted-foreground'}`;
                });

                lucide.createIcons();
                // INICIALIZA O ZOOM
                setTimeout(() => MapControls.init(), 100);

            },

            updateButtons: () => {
                const els = ['btn-create', 'btn-join'];
                els.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.disabled = State.ui.isProcessing;
                        btn.innerText = State.ui.isProcessing ? "Carregando..." : (id === 'btn-create' ? "Criar Sala" : "Conectar");
                    }
                });
            },

            showEndGame: (msg) => {
                const dlg = document.getElementById('end-game-dialog');
                document.getElementById('end-game-message').innerText = msg;
                dlg.classList.remove('hidden');
                dlg.classList.add('flex');

                if (State.isCreator) {
                    const btnRestart = document.getElementById('btn-restart');
                    if (btnRestart) btnRestart.classList.remove('hidden');
                }

                // --- GRÁFICO ATUALIZADO ---
                // Pega o histórico do servidor (se não tiver, usa fallback)
                const history = State.serverData.education_history || [5];
                const labels = history.map((_, i) => `Turno ${i}`);

                // Define a cor: Verde se subiu, Vermelho se caiu/manteve baixo
                const startVal = history[0];
                const endVal = history[history.length - 1];
                const isPositive = endVal > startVal;

                // Cores Tailwind: Emerald-500 (#10b981) ou Red-500 (#ef4444)
                const lineColor = isPositive ? '#10b981' : '#ef4444';
                const areaColor = isPositive ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';

                const ctx = document.getElementById('educationChart').getContext('2d');

                if (window.myEndChart) window.myEndChart.destroy();

                window.myEndChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Educação & Consciência Crítica',
                            data: history,
                            borderColor: lineColor,
                            backgroundColor: areaColor,
                            borderWidth: 3,
                            tension: 0.3, // Curva suave
                            fill: true,
                            pointRadius: 4,
                            pointBackgroundColor: lineColor
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10,
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                ticks: { color: '#aaa' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#aaa' }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#fff', font: { family: 'Lora' } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `Educação: ${ctx.raw}`
                                }
                            }
                        }
                    }
                });
            }
        };

        // Initialize
        Game.init();

    </script>

    <script src="scripts/playersClases.js"></script>
</body>

</html>